{% extends 'base.html' %}

{% block title %}
  <title>borrower get item</title>
{% endblock %}

{% block content %}
  <script>
    function confirmGetItem() {
      return confirm('Are you sure you already got this item?')
    }
  </script>

  <script>
    function initMap() {
      var geocoder = new google.maps.Geocoder()
      var address = '{{ item_address }}'
      var map = new google.maps.Map(document.getElementById('get-item-map'), {
        zoom: 10,
        center: { lat: -34.397, lng: 150.644 }
      })
    
      var directionsService = new google.maps.DirectionsService()
      var directionsRenderer = new google.maps.DirectionsRenderer()
      directionsRenderer.setMap(map)
    
      function addMarker(location, title, isUserLocation = false) {
        var markerOptions = {
          map: map,
          position: location,
          title: title
        }
    
        if (isUserLocation) {
          markerOptions.icon = {
            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
          }
        }
    
        var marker = new google.maps.Marker(markerOptions)
      }
    
      geocoder.geocode({ address: address }, function (results, status) {
        if (status === 'OK') {
          var destinationLocation = results[0].geometry.location
          addMarker(destinationLocation, 'Item Location')
    
          map.setCenter(destinationLocation)
    
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function (position) {
                var userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                }
    
                addMarker(userLocation, 'Your Location', true)
    
                directionsService.route(
                  {
                    origin: userLocation,
                    destination: destinationLocation,
                    travelMode: 'DRIVING'
                  },
                  function (response, status) {
                    if (status === 'OK') {
                      directionsRenderer.setDirections(response)
                    } else {
                      window.alert('Directions request failed due to ' + status)
                    }
                  }
                )
              },
              function () {
                alert('Error: The Geolocation service failed.')
              }
            )
          } else {
            alert("Error: Your browser doesn't support geolocation.")
          }
        } else {
          console.error('Geocode was not successful for the following reason: ' + status)
        }
      })
    }
    
    function updateTimeAndCheck() {
      var startTimeString = document.getElementById('get-item-info').getAttribute('data-start-time')
      var startTime = new Date(startTimeString)
      var currentTime = new Date()
      var timeDiff = Math.abs(currentTime - startTime)
      var diffInSeconds = timeDiff / 1000
      var minutes = Math.floor(diffInSeconds / 60)
      var seconds = Math.floor(diffInSeconds % 60)
    
      if (currentTime > startTime) {
        var Timeoutwarn = document.getElementById('Timeout')
        Timeoutwarn.textContent = 'Delay ' + minutes + ' min  ' + seconds + ' sec'
        Timeoutwarn.style.color = 'red'
      }
    
      if ((currentTime > startTime) & (minutes >= 60)) {
        var xhr = new XMLHttpRequest()
        var cancelOrderUrl = document.getElementById('cancel-order-url').getAttribute('cancel-url')
        xhr.open('POST', cancelOrderUrl, true)
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')
        xhr.send()
    
        var userConfirmed = confirm('You are late more than one hour')
        if (userConfirmed) {
          window.location.href = "{% url 'latest_status_user_orders' %}"
        }
      }
    }
    
    document.addEventListener('DOMContentLoaded', function () {
      updateTimeAndCheck()
      setInterval(updateTimeAndCheck, 1000)
    })
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>

  <div class="get-item-page-container">
    <div id="cancel-order-url" cancel-url="{% url 'cancel_order' order.order_id %}"></div>
    <h2>Get item location</h2>

    <div id="get-item-map"></div>

    <div class="get-item-info">
      <div class="get-item-info-left">
        <p>Contributor: {{ order.item.contributor }}</p>
        <p>Item Address:</p>
        <p>{{ order.item.item_address }}</p>

        <div id="get-item-info" data-start-time="{{ order.start_time|date:'Y-m-d H:i:s' }}"></div>
      </div>
      <div class="get-item-info-right">
        <p id="Timeout"></p>
        <form action="{% url 'update_to_get_item' order.order_id %}" method="post" onsubmit="return confirmGetItem()">
          {% csrf_token %}
          <button type="submit" class="get-item-btn">Get item</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
